<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AutoCare Plus | Command Insights</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --accent: #00d2ff;
            --glass: rgba(10, 15, 28, 0.96);
            --border: rgba(255, 255, 255, 0.12);
            --bg: #020617;
            --success: #10b981;
            --mechanical: #f59e0b;
            --diagnostic: #a855f7;
        }

        * { box-sizing: border-box; }
        body, html {
            margin: 0; padding: 0; height: 100%; width: 100%;
            background-color: var(--bg);
            background-image: radial-gradient(circle at top right, #0a192f, #020617);
            font-family: 'Plus Jakarta Sans', sans-serif; color: white; overflow-x: hidden;
        }

        /* --- LOGIN & SECURITY --- */
        #loginOverlay, #settingsModal {
            position: fixed; inset: 0; display: flex; align-items: center; justify-content: center;
            background: var(--bg); z-index: 9999;
        }
        #settingsModal { display: none; background: rgba(0,0,0,0.9); backdrop-filter: blur(15px); z-index: 10000; }

        .card-auth {
            background: var(--glass); backdrop-filter: blur(40px);
            padding: 40px; border-radius: 28px; border: 1px solid var(--border);
            width: 90%; max-width: 420px; text-align: center;
            box-shadow: 0 50px 100px rgba(0,0,0,0.8);
        }

        .input-group { margin-bottom: 20px; text-align: left; position: relative; }
        .input-group label { display: block; font-size: 10px; color: #94a3b8; margin-bottom: 8px; text-transform: uppercase; font-weight: 800; }
        
        input {
            width: 100%; background: rgba(255,255,255,0.05); border: 1px solid var(--border);
            border-radius: 14px; padding: 16px; color: white; font-family: inherit; font-size: 15px; outline: none;
        }
        input:focus { border-color: var(--accent); background: rgba(255,255,255,0.1); }

        .toggle-pass { position: absolute; right: 15px; top: 38px; cursor: pointer; opacity: 0.5; }

        .btn {
            width: 100%; background: var(--accent); color: #020617; border: none; padding: 18px;
            border-radius: 14px; font-weight: 800; cursor: pointer; text-transform: uppercase; transition: 0.3s;
        }
        .btn:hover { background: #fff; transform: translateY(-2px); }

        /* --- DASHBOARD --- */
        #mainContent { display: none; flex-direction: column; width: 100%; opacity: 0; transition: 0.8s; }
        .header { 
            padding: 20px 40px; display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid var(--border); background: rgba(2, 6, 23, 0.8); backdrop-filter: blur(10px);
            position: sticky; top: 0; z-index: 100;
        }

        .insights-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 20px; padding: 30px 40px; }
        .insight-card { background: var(--glass); border: 1px solid var(--border); border-radius: 24px; padding: 25px; position: relative; }
        .insight-card h3 { margin: 0 0 15px 0; font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--accent); }
        .big-stat { font-size: 42px; font-weight: 800; }

        /* --- TABLE --- */
        .table-section { padding: 0 40px 40px; }
        .table-container { background: var(--glass); border-radius: 24px; border: 1px solid var(--border); overflow: hidden; }
        table { width: 100%; border-collapse: collapse; text-align: left; }
        th { padding: 20px; font-size: 11px; color: var(--accent); text-transform: uppercase; border-bottom: 1px solid var(--border); }
        td { padding: 20px; border-bottom: 1px solid var(--border); font-size: 14px; }
        .cat-tag { padding: 5px 12px; border-radius: 6px; font-size: 10px; font-weight: 800; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="card-auth">
            <h2>Command Insights</h2>
            <p style="color:var(--accent); font-size: 11px; letter-spacing: 2px; text-transform: uppercase;">Secure Data Terminal</p>
            <div class="input-group">
                <label>Terminal ID</label>
                <input type="email" id="email" placeholder="Autocareplus@org.com">
            </div>
            <div class="input-group">
                <label>Security Key</label>
                <input type="password" id="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
                <span class="toggle-pass" onclick="togglePass('password')">üëÅÔ∏è</span>
            </div>
            <button class="btn" onclick="attemptLogin()">Authorize & Enter</button>
            <p id="loginError" style="color:red; font-size:12px; display:none; margin-top:15px; font-weight:700;">ACCESS DENIED</p>
            <button style="background:none; border:none; color:var(--accent); cursor:pointer; font-size:11px; margin-top:15px; text-decoration:underline;" onclick="openSettings()">Reset Access Key</button>
        </div>
    </div>

    <div id="mainContent">
        <div class="header">
            <div>
                <h1 style="margin:0; font-size:20px;">Revenue Intelligence</h1>
                <span style="font-size:10px; color:var(--success); font-weight:800;">‚óè 7-DAY PRODUCTIVITY TREND</span>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="width:auto; padding:10px 20px; font-size:11px; background:var(--success);" onclick="downloadReport()">Download CSV</button>
                <button class="btn" style="width:auto; padding:10px 20px; font-size:11px; background:transparent; color:white; border:1px solid var(--border);" onclick="openSettings()">Settings</button>
            </div>
        </div>

        <div class="insights-grid">
            <div class="insight-card" style="border-top: 3px solid var(--success);">
                <h3>Ready Revenue</h3>
                <div class="big-stat" id="totalRev">‚Ç¨0</div>
                <small style="opacity:0.5;">Unbilled Workshop Value</small>
            </div>

            <div class="insight-card">
                <h3>Classification Mix</h3>
                <div style="height: 150px;"><canvas id="distChart"></canvas></div>
            </div>

            <div class="insight-card" style="grid-column: span 1;">
                <h3>7-Day Completed Trend</h3>
                <div style="height: 150px;"><canvas id="historyChart"></canvas></div>
            </div>
        </div>

        <div class="table-section">
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Classification</th>
                            <th>Count</th>
                            <th>Estimated Value</th>
                            <th>Market Level</th>
                        </tr>
                    </thead>
                    <tbody id="breakdownTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="settingsModal">
        <div class="card-auth">
            <h3>Update Access Key</h3>
            <div class="input-group">
                <label>New Password</label>
                <input type="password" id="newPass" placeholder="Enter new key">
            </div>
            <button class="btn" onclick="saveNewPassword()">Apply & Refresh</button>
            <button class="btn" style="background:transparent; color:white; margin-top:10px;" onclick="closeSettings()">Cancel</button>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const db = getFirestore(initializeApp({
        apiKey: "AIzaSyD9cPmUCMEtT7XukcAxmeS50jKh1A2f31Q",
        projectId: "auto-care-plus-e7fdf"
    }));

    const PRICING = {
        GENERAL: { color: "#10b981", avg: 280, keywords: ["service", "oil", "nct"] },
        MECHANICAL: { color: "#f59e0b", avg: 450, keywords: ["brake", "clutch", "belt", "repair", "tyre"] },
        DIAGNOSTIC: { color: "#a855f7", avg: 75, keywords: ["scan", "diagnostic", "fault"] }
    };

    let globalStats = {};

    async function sha256(msg) {
        const hash = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(msg));
        return Array.from(new Uint8Array(hash)).map(b => b.toString(16).padStart(2, '0')).join('');
    }

    window.togglePass = (id) => {
        const x = document.getElementById(id);
        x.type = x.type === "password" ? "text" : "password";
    };

    window.openSettings = () => document.getElementById('settingsModal').style.display = 'flex';
    window.closeSettings = () => document.getElementById('settingsModal').style.display = 'none';

    window.saveNewPassword = async () => {
        const val = document.getElementById('newPass').value.trim();
        if(val.length < 6) return alert("Min 6 chars");
        localStorage.setItem('staffHash', await sha256(val));
        location.reload();
    };

    window.attemptLogin = async () => {
        const email = document.getElementById('email').value.trim().toLowerCase();
        const pass = document.getElementById('password').value;
        const target = localStorage.getItem('staffHash') || "a60965e69e46950275817d7b278156172551a1334f1989025176b1b70951a592";
        
        if(email === "autocareplus@org.com" && await sha256(pass) === target) {
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('mainContent').style.display = 'flex';
            setTimeout(() => document.getElementById('mainContent').style.opacity = '1', 50);
            startLiveFeed();
        } else {
            document.getElementById('loginError').style.display = 'block';
        }
    };

    let distChart, historyChart;

    function startLiveFeed() {
        distChart = new Chart(document.getElementById("distChart"), {
            type: 'doughnut',
            data: { labels: ['General', 'Mechanical', 'Diagnostic'], datasets: [{ data: [0,0,0], backgroundColor: ['#10b981', '#f59e0b', '#a855f7'], borderWidth: 0 }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, cutout: '80%' }
        });

        historyChart = new Chart(document.getElementById("historyChart"), {
            type: 'line',
            data: { labels: [], datasets: [{ label: 'Jobs Done', data: [], borderColor: '#00d2ff', backgroundColor: 'rgba(0, 210, 255, 0.1)', fill: true, tension: 0.4 }] },
            options: { maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { display: false }, x: { grid: { display: false }, ticks: { font: { size: 9 } } } } }
        });

        onSnapshot(collection(db, "jobs"), snap => {
            let stats = { GENERAL: { count: 0, rev: 0 }, MECHANICAL: { count: 0, rev: 0 }, DIAGNOSTIC: { count: 0, rev: 0 } };
            let total = 0;
            let timeline = {};

            // Initialize last 7 days
            for(let i=6; i>=0; i--) {
                let d = new Date(); d.setDate(d.getDate() - i);
                timeline[d.toLocaleDateString('en-IE', { weekday: 'short' })] = 0;
            }

            snap.forEach(doc => {
                const j = doc.data();
                const text = (j.serviceType || "").toLowerCase();
                let cat = "GENERAL";
                if(PRICING.MECHANICAL.keywords.some(k => text.includes(k))) cat = "MECHANICAL";
                else if(PRICING.DIAGNOSTIC.keywords.some(k => text.includes(k))) cat = "DIAGNOSTIC";

                stats[cat].count++;

                if(j.status === "READY" || j.status === "COMPLETED") {
                    stats[cat].rev += PRICING[cat].avg;
                    total += PRICING[cat].avg;

                    // Timeline logic
                    if(j.completedAt) {
                        const date = j.completedAt.toDate().toLocaleDateString('en-IE', { weekday: 'short' });
                        if(timeline.hasOwnProperty(date)) timeline[date]++;
                    }
                }
            });

            globalStats = stats;
            document.getElementById("totalRev").innerText = "‚Ç¨" + total.toLocaleString();
            
            distChart.data.datasets[0].data = [stats.GENERAL.count, stats.MECHANICAL.count, stats.DIAGNOSTIC.count];
            distChart.update();

            historyChart.data.labels = Object.keys(timeline);
            historyChart.data.datasets[0].data = Object.values(timeline);
            historyChart.update();

            document.getElementById("breakdownTable").innerHTML = Object.keys(stats).map(key => `
                <tr>
                    <td><span class="cat-tag" style="background:${PRICING[key].color}22; color:${PRICING[key].color}">${key}</span></td>
                    <td><b>${stats[key].count}</b> Active Jobs</td>
                    <td>‚Ç¨${stats[key].rev.toLocaleString()}</td>
                    <td style="opacity:0.6;">Standard IE Garage Rate</td>
                </tr>
            `).join('');
        });
    }

    window.downloadReport = () => {
        let csv = "Classification,Job Count,Estimated Revenue\n";
        Object.keys(globalStats).forEach(k => { csv += `${k},${globalStats[k].count},‚Ç¨${globalStats[k].rev}\n`; });
        const blob = new Blob([csv], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `AutoCare_Insights_${new Date().toLocaleDateString()}.csv`;
        a.click();
    };
</script>
</body>
</html>
