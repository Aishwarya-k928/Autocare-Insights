<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AutoCare Plus | Business Intelligence</title>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #00d2ff; --glass: rgba(10, 15, 28, 0.96); --bg: #020617;
            --success: #39ff14; --warning: #f59e0b; --danger: #ff3131; --border: rgba(255, 255, 255, 0.12);
        }
        body { background: var(--bg); color: white; font-family: 'Plus Jakarta Sans', sans-serif; margin: 0; padding: 0; }
        
        .header { padding: 20px 40px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; background: rgba(2,6,23,0.9); }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; padding: 30px; }
        
        .kpi-card { background: var(--glass); border: 1px solid var(--border); border-radius: 24px; padding: 25px; position: relative; }
        .kpi-card h3 { font-size: 10px; text-transform: uppercase; letter-spacing: 1px; color: var(--accent); margin: 0; }
        .kpi-val { font-size: 36px; font-weight: 800; margin: 15px 0 5px; }
        
        .status-dot { height: 8px; width: 8px; border-radius: 50%; display: inline-block; margin-right: 5px; }
        
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th { text-align: left; font-size: 11px; color: var(--accent); padding: 15px; border-bottom: 1px solid var(--border); }
        td { padding: 15px; border-bottom: 1px solid var(--border); font-size: 14px; }
        
        .back-btn { background: transparent; border: 1px solid var(--accent); color: var(--accent); padding: 10px 20px; border-radius: 10px; cursor: pointer; text-decoration: none; font-size: 12px; font-weight: 700; }
        .back-btn:hover { background: var(--accent); color: black; }
    </style>
</head>
<body>

    <div class="header">
        <div>
            <h1 style="margin:0; font-size:22px;">Business Intelligence</h1>
            <span style="font-size:9px; color:var(--success);">● REAL-TIME PERFORMANCE TRACKING</span>
        </div>
        <a href="index.html" class="back-btn">Back to Workshop</a>
    </div>

    <div class="grid">
        <div class="kpi-card">
            <h3>Workflow Value (Uncollected)</h3>
            <div class="kpi-val" id="pipeRev">€0</div>
            <p style="font-size:11px; opacity:0.6;">Total value of New, Servicing, and Ready jobs</p>
        </div>

        <div class="kpi-card">
            <h3>Critical Delay Rate</h3>
            <div class="kpi-val" id="delayCount" style="color:var(--danger);">0</div>
            <p style="font-size:11px; opacity:0.6;">Jobs exceeding the 6-hour threshold</p>
        </div>

        <div class="kpi-card">
            <h3>Priority Ratio</h3>
            <div class="kpi-val" id="prioPerc">0%</div>
            <p style="font-size:11px; opacity:0.6;">Percentage of starred priority tasks</p>
        </div>
    </div>

    <div style="padding: 0 30px;">
        <div class="kpi-card">
            <h3>Lane Efficiency Analysis</h3>
            <table>
                <thead>
                    <tr>
                        <th>Lane Status</th>
                        <th>Active Count</th>
                        <th>Estimated Value</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody id="laneStats"></tbody>
            </table>
        </div>
    </div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
    import { getFirestore, collection, onSnapshot } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

    const db = getFirestore(initializeApp({
        apiKey: "AIzaSyD9cPmUCMEtT7XukcAxmeS50jKh1A2f31Q",
        projectId: "auto-care-plus-e7fdf"
    }));

    const RATES = { GENERAL: 280, MECHANICAL: 450, DIAGNOSTIC: 75 };

    onSnapshot(collection(db, "jobs"), (snap) => {
        let totalVal = 0;
        let prioCount = 0;
        let delayCount = 0;
        let lanes = { NEW: 0, SERVICING: 0, READY: 0, COLLECTED: 0 };
        let laneVals = { NEW: 0, SERVICING: 0, READY: 0, COLLECTED: 0 };

        snap.forEach(d => {
            const j = d.data();
            const stage = (j.status || "NEW").toUpperCase();
            const type = (j.serviceType || "").toLowerCase();
            
            // Calculate Value
            let val = RATES.GENERAL;
            if(type.includes("brake") || type.includes("clutch")) val = RATES.MECHANICAL;
            if(type.includes("scan") || type.includes("diag")) val = RATES.DIAGNOSTIC;

            if(stage !== "COLLECTED") {
                totalVal += val;
                lanes[stage]++;
                laneVals[stage] += val;
                if(j.isPriority) prioCount++;
                
                // Track 6hr Delays
                const mins = j.createdAt ? (new Date() - j.createdAt.toDate()) / 60000 : 0;
                if(mins >= 360) delayCount++;
            }
        });

        const totalActive = snap.size - lanes.COLLECTED;
        
        document.getElementById("pipeRev").innerText = "€" + totalVal.toLocaleString();
        document.getElementById("delayCount").innerText = delayCount;
        document.getElementById("prioPerc").innerText = totalActive > 0 ? Math.round((prioCount / totalActive) * 100) + "%" : "0%";

        document.getElementById("laneStats").innerHTML = Object.keys(lanes).filter(l => l !== 'COLLECTED').map(l => `
            <tr>
                <td><b>${l}</b></td>
                <td>${lanes[l]} Units</td>
                <td>€${laneVals[l].toLocaleString()}</td>
                <td><span class="status-dot" style="background:${lanes[l] > 5 ? 'var(--danger)' : 'var(--success)'}"></span> ${lanes[l] > 5 ? 'High Load' : 'Stable'}</td>
            </tr>
        `).join('');
    });
</script>
</body>
</html>
